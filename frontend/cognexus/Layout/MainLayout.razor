@using Majorsoft.Blazor.Components.Common.JsInterop.GlobalMouseEvents
@using Majorsoft.Blazor.Components.Common.JsInterop.Resize
@inject CognexusBlazor.Services.RendererService RendererService
@inject IJSRuntime JSRuntime
@inject IResizeHandler ResizeHandler
@implements IAsyncDisposable
@inherits LayoutComponentBase

<canvas id="node-graph"
        width="@_canvasWidth"
        height="@_canvasHeight"
        @onwheel="OnWheel"
        @onmousedown="OnMouseDown"
        @onmouseup="OnMouseUp"
        @onmousemove="OnMouseMove">
</canvas>

<div class="page" @onwheel="OnPageWheel" @onmousedown="OnPageMouseDown" @onmouseup="OnMouseUp" @onmousemove="OnPageMouseMove">
    <div class="sidebar">
        <NavMenu/>
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
    
    <button class="btn btn-primary" @onclick="DrawTestQuad">Draw Test Quad</button>
    
</div>

@code {
    private string? _error;
    private bool _isPanning = false;
    private double _lastMouseX;
    private double _lastMouseY;
    private int _canvasWidth = 300;
    private int _canvasHeight = 150;
    private string? _resizeEventId;

    protected override async Task OnInitializedAsync()
    {
        // Don't fetch viewport dimensions here - let it use defaults (300x150)
        // We'll get actual dimensions after renderer initializes
        await Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await RendererService.InitializeAsync("node-graph", _canvasWidth, _canvasHeight);
                
                // Get actual page size and resize immediately
                var pageSize = await ResizeHandler.GetPageSizeAsync();
                
                var resizeCommand = new Cognexus.Commands.ResizeViewportCommand
                {
                    Width = (uint)pageSize.Width,
                    Height = (uint)pageSize.Height
                };
                
                using var stream = new MemoryStream();
                using var codedOutput = new Google.Protobuf.CodedOutputStream(stream);
                resizeCommand.WriteTo(codedOutput);
                codedOutput.Flush();
                var bytes = stream.ToArray();
                
                await RendererService.HandleResizeViewportCommandAsync(bytes);
                await RendererService.RenderAsync();
                
                // Subscribe to window resize events
                _resizeEventId = await ResizeHandler.RegisterPageResizeAsync(OnWindowResize);
            }
            catch (Exception ex)
            {
                _error = $"Failed to initialize renderer: {ex.Message}";
                StateHasChanged();
            }
        }
    }
    
    private async Task OnWindowResize(ResizeEventArgs args)
    {
        try
        {
            var command = new Cognexus.Commands.ResizeViewportCommand
            {
                Width = (uint)args.Width,
                Height = (uint)args.Height
            };

            using var stream = new MemoryStream();
            using var codedOutput = new Google.Protobuf.CodedOutputStream(stream);
            command.WriteTo(codedOutput);
            codedOutput.Flush();
            var bytes = stream.ToArray();

            await RendererService.HandleResizeViewportCommandAsync(bytes);
        }
        catch (Exception ex)
        {
            _error = $"Resize failed: {ex.Message}";
        }
    }

    private async Task OnWheel(WheelEventArgs e)
    {
        try
        {
            var command = new Cognexus.Commands.ZoomCameraCommand
            {
                Delta = (float)e.DeltaY,
                PivotX = (float)e.OffsetX,
                PivotY = (float)e.OffsetY
            };

            using var stream = new MemoryStream();
            using var codedOutput = new Google.Protobuf.CodedOutputStream(stream);
            command.WriteTo(codedOutput);
            codedOutput.Flush();
            var bytes = stream.ToArray();

            await RendererService.HandleZoomCameraCommandAsync(bytes);
        }
        catch (Exception ex)
        {
            _error = $"Zoom failed: {ex.Message}";
        }
    }

    private void OnMouseDown(MouseEventArgs e)
    {
        _isPanning = true;
        _lastMouseX = e.ClientX;
        _lastMouseY = e.ClientY;
    }

    private void OnMouseUp(MouseEventArgs e)
    {
        _isPanning = false;
    }

    private async Task OnMouseMove(MouseEventArgs e)
    {
        if (!_isPanning) return;

        try
        {
            var deltaX = (float)(e.ClientX - _lastMouseX);
            var deltaY = (float)(e.ClientY - _lastMouseY);

            var command = new Cognexus.Commands.PanCameraCommand
            {
                DeltaX = deltaX,
                DeltaY = -deltaY  // Invert Y axis: drag up = move up
            };

            using var stream = new MemoryStream();
            using var codedOutput = new Google.Protobuf.CodedOutputStream(stream);
            command.WriteTo(codedOutput);
            codedOutput.Flush();
            var bytes = stream.ToArray();

            await RendererService.HandlePanCameraCommandAsync(bytes);

            _lastMouseX = e.ClientX;
            _lastMouseY = e.ClientY;
        }
        catch (Exception ex)
        {
            _error = $"Pan failed: {ex.Message}";
        }
    }

    private async Task DrawTestQuad()
    {
        try
        {
            var command = new Cognexus.Commands.DrawQuadCommand
            {
                X = 0,
                Y = 0,
                Z = 0,
                Width = 0.5f,
                Height = 0.5f,
                R = 0.8f,
                G = 0.2f,
                B = 0.2f,
                A = 1.0f
            };

            using var stream = new MemoryStream();
            using var codedOutput = new Google.Protobuf.CodedOutputStream(stream);
            command.WriteTo(codedOutput);
            codedOutput.Flush();
            var bytes = stream.ToArray();

            await RendererService.HandleDrawQuadCommandAsync(bytes);
        }
        catch (Exception ex)
        {
            _error = $"Failed to draw quad: {ex.Message}";
        }
    }

    private async Task OnPageWheel(WheelEventArgs e)
    {
        await OnWheel(e);
    }

    private void OnPageMouseDown(MouseEventArgs e)
    {
        OnMouseDown(e);
    }

    private async Task OnPageMouseMove(MouseEventArgs e)
    {
        await OnMouseMove(e);
    }

    public async ValueTask DisposeAsync()
    {
        if (!string.IsNullOrEmpty(_resizeEventId))
        {
            await ResizeHandler.RemovePageResizeAsync(_resizeEventId);
        }
    }
}
